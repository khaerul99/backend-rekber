// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}
 
datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id           String        @id @default(uuid())
  username     String
  email        String        @unique
  password     String    
  role         Role          @default(MEMBER)

  bank_name      String?
  bank_account   String?
  bank_holder    String?

  pin            String?  
  twofa_secret   String?  
  twofa_enabled  Boolean  @default(false) 
  chats          Chat[]
  notifications  Notification[]

  resetPasswordToken   String?   @unique
  resetPasswordExpires DateTime?

  givenReviews    Review[] @relation("GivenReviews")
  receivedReviews Review[] @relation("ReceivedReviews")
  
  createdAt    DateTime      @default(now())

  // Relasi
  transactionsAsBuyer  Transaction[] @relation("Buyer")
  transactionsAsSeller Transaction[] @relation("Seller")
}

model Transaction {
  id               String    @id @default(uuid())
  trx_code         String    @unique 
  amount           Decimal
  admin_fee        Decimal
  total_transfer   Decimal
  description      String?
  status           Status    @default(PENDING_PAYMENT)
  chats            Chat[]
  proofs           TransactionProof[]
  review           Review?
  resiString    String?
  
  auto_complete_at DateTime? 
  
  buyerId          String
  sellerId         String
  buyer            User      @relation("Buyer", fields: [buyerId], references: [id])
  seller           User      @relation("Seller", fields: [sellerId], references: [id])
  
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
}

model Chat {
  idString       String      @id @default(uuid())
  message        String      @db.Text
  is_read        Boolean     @default(false)
  createdAt      DateTime    @default(now())

  transactionId  String
  senderId       String
  
  transaction    Transaction @relation(fields: [transactionId], references: [id])
  sender         User        @relation(fields: [senderId], references: [id])
}

model Review {
  id            String      @id @default(uuid())
  rating        Int         
  comment       String      @db.Text
  
  // Relasi
  transactionId String      @unique 
  transaction   Transaction @relation(fields: [transactionId], references: [id])
  
  reviewerId    String      
  reviewer      User        @relation("GivenReviews", fields: [reviewerId], references: [id])
  
  targetId      String      
  target        User        @relation("ReceivedReviews", fields: [targetId], references: [id])

  createdAt     DateTime    @default(now())
}

model Notification {
  id        String   @id @default(uuid())
  userId    String   
  user      User     @relation(fields: [userId], references: [id])
  
  title     String
  message   String
  isRead    Boolean  @default(false)
  link      String?  
  
  createdAt DateTime @default(now())
}

model TransactionProof {
  id            String      @id @default(uuid())
  transactionId String
  type          String      // 'payment_proof' atau 'shipping_proof'
  imageUrl      String      // Nama file gambar
  createdAt     DateTime    @default(now())


 
  transaction   Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
}

model AdminBankAccount {
  id          String   @id @default(uuid())
  bankName    String
  bankNumber  String
  bankHolder  String
  logoUrl     String?  // URL Logo Bank
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

enum Role {
  ADMIN
  MEMBER
}

enum Status {
  PENDING_PAYMENT
  VERIFYING       
  PROCESSED       
  SENT            
  COMPLETED 
  DISBURSED      
  DISPUTED        
  CANCELLED
  RETURN_PROCESS  
  RETURN_SENT     
  REFUND_PENDING  
  REFUNDED
}

model SystemSetting {
  id        String   @id @default(uuid())
  key       String   @unique  
  value     String   @db.Text 
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}